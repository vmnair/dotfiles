# Essential Zsh settings stty -ixon  # Disable software flow control to allow Ctrl+S for tmux sessionizer

# Starship prompt
eval "$(starship init zsh)"

# Completion optimization - Phase 1: Caching & Lazy Loading
# Fast completion options
zstyle ':completion:*' use-cache on
zstyle ':completion:*' cache-path "$ZSH_CACHE_DIR/zcompcache"
zstyle ':completion:*' accept-exact '*(N)'
zstyle ':completion:*' use-perl on
zstyle ':completion::complete:*' use-fuzzy 2> /dev/null

# Lazy completion loading
autoload -Uz compinit
# Only regenerate compdump once a day
# _comp_files=(${ZDOTDIR:-$HOME}/.zcompdump(#qN.mh+24))
# if (( $#_comp_files )); then
#   compinit -C
# else
#   compinit
# fi
# unset _comp_files

# Optimized completion menu
zstyle ':completion:*:*:*:*:*' menu select
zstyle ':completion:*' completer _expand _complete _ignored _approximate

# Zsh plugins - Phase 2: Optimized Loading Strategy
# Load all plugins immediately but with optimized configuration

# Zsh-autosuggestions performance settings
export ZSH_AUTOSUGGEST_MANUAL_REBIND=1
export ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20
export ZSH_AUTOSUGGEST_USE_ASYNC=1

# Load plugins (zsh-autocomplete removed - was causing 9s delay)
if [[ $TERM != "dumb" ]]; then
  source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
  source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
  # Note: zsh-autosuggestions provides inline suggestions as you type
fi

# Secrets file
source ~/.secrets

# Editor configuration
export EDITOR="nvim"

# Neovim aliases
alias v=nvim      # Stable neovim
alias vi=nvim
alias vim=nvim    # Stable neovim

# Core aliases
alias zsh_config="nvim ~/.zshrc"
alias dot="nvim ~/dotfiles"
alias nvc="cd ~/dotfiles/neovim/nvim && nvim ."
alias gc="cd ~/.config/ghostty && nvim config"
alias lg="lazygit"
alias update="brew update && brew upgrade && brew cleanup"
alias todo="nvim -c ':TodoOpen'"

# ZK (Zettelkasten) functionality
source "$HOME/dotfiles/zsh/zk_functions.zsh"

# opencode
alias oc="opencode"

# Eza aliases (enhanced ls)
alias l="eza --icons"
alias ls="eza --icons"
alias ll="eza -lg --icons"
alias la="eza -lag --icons"

# Development tool paths - Phase 3: Optimized PATH Setup
# Additional PATH components (brew shellenv loaded in .zprofile)
export PATH="$HOME/Neovim/nvim-macos-arm64/bin:/opt/homebrew/opt/llvm/bin:/usr/local/bin/lua5.1:$PATH"
export LUA_PATH="/usr/local/share/lua/5.1/?.lua;;"
export LUA_CPATH="/usr/local/lib/lua/5.1/?.so;;"
export MANPAGER="nvim +Man!"

# Tool initialization - Phase 3: Cached/Conditional Loading

# FZF configuration (cache the init script)
if [[ ! -f "$HOME/.cache/fzf-init.zsh" ]] || [[ "$HOME/.cache/fzf-init.zsh" -ot "$(which fzf 2>/dev/null)" ]]; then
  mkdir -p "$HOME/.cache"
  fzf --zsh > "$HOME/.cache/fzf-init.zsh" 2>/dev/null
fi
source "$HOME/.cache/fzf-init.zsh" 2>/dev/null || eval "$(fzf --zsh)"
export FZF_DEFAULT_OPTS="--reverse"
export FZF_CTRL_T_OPTS="
  --walker-skip .git,node_modules,target
  --preview 'bat -n --color=always {}'
  --bind 'ctrl-/:change-preview-window(down|hidden|)'"

# Zoxide configuration (cache the init script)
if [[ ! -f "$HOME/.cache/zoxide-init.zsh" ]] || [[ "$HOME/.cache/zoxide-init.zsh" -ot "$(which zoxide 2>/dev/null)" ]]; then
  mkdir -p "$HOME/.cache"
  zoxide init zsh --cmd cd > "$HOME/.cache/zoxide-init.zsh" 2>/dev/null
fi
source "$HOME/.cache/zoxide-init.zsh" 2>/dev/null || eval "$(zoxide init zsh --cmd cd)"

# Version managers - Phase 3: Lazy Loading Optimization

# Python version manager (lazy load)
export PYENV_ROOT="$HOME/.pyenv"
pyenv() {
  # Lazy load pyenv on first use
  unset -f pyenv
  [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
  eval "$(command pyenv init -)"
  pyenv "$@"
}

# Node version manager (lazy load)
export NVM_DIR="$HOME/.nvm"
nvm() {
  # Lazy load nvm on first use
  unset -f nvm
  [ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"
  [ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"
  nvm "$@"
}

# Node/npm commands trigger lazy loading
node() { nvm >/dev/null 2>&1 && node "$@"; }
npm() { nvm >/dev/null 2>&1 && npm "$@"; }
yarn() { nvm >/dev/null 2>&1 && yarn "$@"; }
pnpm() { nvm >/dev/null 2>&1 && pnpm "$@"; }

# Ollama configuration
export OLLAMA_API_BASE=http://127.0.0.1:11434
export OLLAMA_NUM_THREADS=12  # M3 has 12 cores

# Tmux configuration
alias ss='bash ~/dotfiles/tmux/smart-sessionizer.sh'  # Session selector
# Toggle weather display: minimal (icon + temp) or verbose (city + icon + temp + condition)
alias weather-toggle='f=~/dotfiles/tmux/.weather_verbose; if [ -f "$f" ]; then rm "$f" && echo "Weather: minimal"; else touch "$f" && echo "Weather: verbose"; fi'

tmux_sessionizer() {
  zle push-input
  BUFFER="$HOME/dotfiles/tmux/smart-sessionizer.sh"
  zle accept-line
}

zle -N tmux_sessionizer  # register above function as a zle widget
bindkey '^S' tmux_sessionizer  # bind the widget to Ctrl+S

# Project-specific aliases
alias cqm='cd ~/Projects/cqm && source venv/bin/activate && (kill -9 $(lsof -ti:7860) 2>/dev/null || true) && python cqm_app.py'
